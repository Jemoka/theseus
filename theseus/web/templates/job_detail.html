{% extends "base.html" %}

{% block title %}{{ job.name }} - THESEUS{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Breadcrumb -->
    <nav class="breadcrumbs">
        <a href="/" class="breadcrumb-item no-style">theseus</a>
        <span class="breadcrumb-separator">/</span>
        <a href="/jobs" class="breadcrumb-item no-style">jobs</a>
        <span class="breadcrumb-separator">/</span>
        <a href="/jobs?project={{ job.project or 'general' }}" class="breadcrumb-item no-style">{{ job.project or "general" }}</a>
        <span class="breadcrumb-separator">/</span>
        <a href="/jobs?project={{ job.project or 'general' }}&group={{ job.group or 'default' }}" class="breadcrumb-item no-style">{{ job.group or "default" }}</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-item active">{{ job.name }}</span>
    </nav>

    <!-- Header -->
    <div class="job-detail-header mb-4">
        <div>
            <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-xl font-semibold uppercase tracking-wide">{{ job.name }}</h1>
                {% if job.status.value == "running" and job.is_stale %}
                <span class="status status-running">⚠ Stale</span>
                {% else %}
                {% set status = job.status %}
                {% include "components/status_badge.html" %}
                {% endif %}
            </div>
            <p class="text-xs text-gray-400 font-mono mt-1">
                Run ID: {{ job.run_id }}
            </p>
        </div>

        <!-- Actions -->
        <div class="job-detail-actions">
            {% if job.wandb_url %}
            <a href="{{ job.wandb_url }}" target="_blank" class="btn btn-primary btn-small">
                View in W&B
            </a>
            {% endif %}

            {% if job.slurm_job_id %}
            <span class="tag tag-yellow">
                Slurm: {{ job.slurm_job_id }}
            </span>
            {% endif %}

            <button onclick="confirmDelete()" class="btn btn-danger btn-small">
                Delete
            </button>
        </div>
    </div>

    <!-- Info Grid -->
    <div class="info-grid-responsive mb-4">
        <!-- Job Key -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-label">Job Key</div>
            </div>
            <div class="stat-card-body">
                <div class="text-xs font-mono">{{ job.job_key }}</div>
            </div>
        </div>

        <!-- Started -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-label">Started</div>
            </div>
            <div class="stat-card-body">
                <div class="text-xs">
                    {{ job.start_time | format_timestamp }}
                    {% if job.duration %}
                    <span class="text-2xs text-gray-400">({{ job.duration | format_duration }})</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Hardware -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-label">Hardware</div>
            </div>
            <div class="stat-card-body">
                <div class="text-xs">
                    {% if job.hardware.total_chips > 0 %}
                    {{ job.hardware.total_chips }}× {{ job.hardware.chip or "unknown" }}
                    {% else %}
                    —
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Hosts -->
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-label">Hosts</div>
            </div>
            <div class="stat-card-body">
                <div class="text-xs">
                    {% if job.hardware.hosts %}
                    {{ job.hardware.hosts | join(", ") }}
                    {% else %}
                    —
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="job-detail-content">
        <!-- Log Viewer -->
        <div class="log-viewer-section">
            {% set job = job %}{% set content = log_content %}
            {% include "components/log_viewer.html" %}
        </div>

        <!-- Sidebar -->
        <div class="job-detail-sidebar">
            <!-- Runs -->
            {% if all_runs and all_runs|length > 0 %}
            <div class="card" style="padding: 0;">
                <div class="card-header" style="background: var(--gray-1); padding: var(--spacing-sm) var(--spacing-md); margin: 0;">
                    <h3 class="text-xs font-semibold tracking-wide">Runs ({{ all_runs|length }})</h3>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for run in all_runs %}
                    <a href="/jobs/{{ run.project or 'general' }}/{{ run.group or 'default' }}/{{ run.name }}/{{ run.run_id }}"
                       class="block border-b border-gray-200 p-3 hover:bg-gray-50 transition-colors no-style"
                       style="{% if run.run_id == current_run_id %}background: rgba(0, 0, 0, 0.02);{% endif %}">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-mono text-gray-600">{{ run.run_id }}</span>
                            {% if run.status.value == "running" and run.is_stale %}
                            <span class="status status-running">⚠ Stale</span>
                            {% else %}
                            {% set status = run.status %}
                            {% include "components/status_badge.html" %}
                            {% endif %}
                        </div>
                        <div class="text-2xs text-gray-400 mt-1">
                            {{ run.start_time | format_timestamp }}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Checkpoints -->
            {% if checkpoints %}
            <div class="card" style="padding: 0;">
                <div class="card-header" style="background: var(--gray-1); padding: var(--spacing-sm) var(--spacing-md); margin: 0;">
                    <h3 class="text-xs font-semibold tracking-wide">Checkpoints ({{ checkpoints | length }})</h3>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    {% for ckpt in checkpoints %}
                    <a href="/checkpoints/{{ ckpt.project }}/{{ ckpt.group }}/{{ ckpt.job_name }}/{{ ckpt.suffix }}"
                       class="block border-b border-gray-200 p-3 hover:bg-gray-50 transition-colors no-style">
                        <div class="text-xs font-mono" style="color: var(--blue);">{{ ckpt.suffix }}</div>
                        <div class="text-2xs text-gray-400 mt-1">
                            {{ ckpt.created | format_timestamp }}
                            {% if ckpt.size_bytes %}
                            • {{ ckpt.size_bytes | format_size }}
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Config -->
            <div class="card" style="padding: 0;">
                <details open>
                    <summary class="card-header cursor-pointer" style="background: var(--gray-1); padding: var(--spacing-sm) var(--spacing-md); margin: 0;">
                        <span class="text-xs font-semibold tracking-wide">Config</span>
                    </summary>
                    <div style="padding: var(--spacing-md); max-height: 400px; overflow: auto;">
                        <pre class="text-2xs font-mono text-gray-600" style="white-space: pre-wrap; word-break: break-all;">{{ job.config | tojson(indent=2) }}</pre>
                    </div>
                </details>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    const jobName = "{{ job.name }}";
    const confirmation = prompt(
        `⚠️ WARNING: This will permanently delete this job run and all its data.\n\n` +
        `Type the job name "${jobName}" to confirm deletion:`
    );

    if (confirmation === jobName) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/jobs/{{ job.project or "general" }}/{{ job.group or "default" }}/{{ job.name }}/{{ job.run_id }}/delete';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'confirmation';
        input.value = confirmation;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    } else if (confirmation !== null) {
        alert('Job name did not match. Deletion cancelled.');
    }
}
</script>
{% endblock %}