{% extends "base.html" %}

{% block title %}Jobs - theseus{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="text-xl font-semibold uppercase tracking-wide">Jobs</h1>
        <p class="text-xs text-gray-400 mt-1">
            All job runs across all projects
        </p>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <form class="flex gap-2 items-stretch" method="get">
            <!-- Project filter -->
            <div style="flex: 1; min-width: 150px;">
                <label for="project" class="data-label">Project</label>
                <select name="project" id="project"
                        onchange="this.form.submit()">
                    <option value="">All projects</option>
                    {% for p in projects %}
                    <option value="{{ p.name }}" {% if current_project == p.name %}selected{% endif %}>
                        {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Group filter -->
            <div style="flex: 1; min-width: 150px;">
                <label for="group" class="data-label">Group</label>
                <input type="text" name="group" id="group" value="{{ current_group or '' }}"
                       placeholder="Filter by group">
            </div>

            <!-- Status filter -->
            <div style="flex: 1; min-width: 150px;">
                <label for="status" class="data-label">Status</label>
                <select name="status" id="status"
                        onchange="this.form.submit()">
                    <option value="">All statuses</option>
                    <option value="running" {% if current_status == "running" %}selected{% endif %}>Running</option>
                    <option value="completed" {% if current_status == "completed" %}selected{% endif %}>Completed</option>
                    <option value="failed" {% if current_status == "failed" %}selected{% endif %}>Failed</option>
                    <option value="preempted" {% if current_status == "preempted" %}selected{% endif %}>Preempted</option>
                </select>
            </div>

            <!-- Submit -->
            <div style="display: flex; flex-direction: column; justify-content: flex-end;">
                <label class="data-label" style="visibility: hidden;">Action</label>
                <button type="submit" class="btn btn-primary" style="white-space: nowrap;">
                    Filter
                </button>
            </div>

            <!-- Clear -->
            {% if current_project or current_group or current_status %}
            <div style="display: flex; flex-direction: column; justify-content: flex-end;">
                <label class="data-label" style="visibility: hidden;">Action</label>
                <a href="/jobs" class="btn" style="white-space: nowrap;">
                    Clear
                </a>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Jobs Table -->
    {% if jobs %}
    <div class="table-responsive">
    <table class="table-compact">
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Project/Group</th>
                <th class="hide-mobile-table">Job Key</th>
                <th class="hide-mobile-table">Hardware</th>
                <th>Started</th>
                <th class="hide-mobile-table">Duration</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td>
                    <a href="/jobs/{{ job.project or 'general' }}/{{ job.group or 'default' }}/{{ job.name }}/{{ job.run_id }}"
                       class="font-semibold text-secondary no-style" style="color: var(--blue);">
                        {{ job.name }}
                    </a>
                    <div class="text-2xs text-gray-400 font-mono">
                        {{ job.run_id }}
                    </div>
                </td>
                <td>
                    {% if job.status.value == "running" and job.is_stale %}
                    <span class="status status-running">⚠ Stale</span>
                    {% else %}
                    {% set status = job.status %}
                    {% include "components/status_badge.html" %}
                    {% endif %}
                </td>
                <td class="text-xs">
                    <a href="/jobs?project={{ job.project or 'general' }}" class="text-gray-400 hover:text-secondary no-style" style="color: var(--gray-3);">
                        {{ job.project or "general" }}
                    </a>
                    /
                    <a href="/jobs?project={{ job.project or 'general' }}&group={{ job.group or 'default' }}" class="text-gray-400 hover:text-secondary no-style" style="color: var(--gray-3);">
                        {{ job.group or "default" }}
                    </a>
                </td>
                <td class="font-mono text-xs text-gray-400 hide-mobile-table">
                    {{ job.job_key }}
                </td>
                <td class="text-xs text-gray-400 hide-mobile-table">
                    {% if job.hardware.total_chips > 0 %}
                    {{ job.hardware.total_chips }}× {{ job.hardware.chip or "?" }}
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td class="text-xs text-gray-400">
                    {{ job.start_time | format_timestamp }}
                </td>
                <td class="text-xs text-gray-400 hide-mobile-table">
                    {% if job.duration %}
                    {{ job.duration | format_duration }}
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td class="text-xs">
                    <a href="/jobs/{{ job.project or 'general' }}/{{ job.group or 'default' }}/{{ job.name }}/{{ job.run_id }}"
                       class="font-semibold no-style" style="color: var(--blue);">
                        View
                    </a>
                    {% if job.wandb_url %}
                    <span class="text-gray-400 mx-1">|</span>
                    <a href="{{ job.wandb_url }}" target="_blank"
                       class="font-semibold no-style" style="color: var(--blue);">
                        W&B
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

    <!-- Results count -->
    <div class="text-2xs text-gray-400 mt-3">
        Showing {{ jobs | length }} jobs
    </div>

    {% else %}
    <div class="empty-state card">
        <p class="empty-state-text">
            {% if current_project or current_group or current_status %}
            No jobs match the current filters
            {% else %}
            No jobs have been run yet
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
