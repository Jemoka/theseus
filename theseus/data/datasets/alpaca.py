from datasets import load_dataset

from theseus.data.datasets import ChatTemplate, ChatTemplateDataset, ChatTurn


def template(instruction: str, input_text: str, output: str) -> ChatTemplate:
    if input_text:
        return [
            ChatTurn(role="system", message=instruction),
            ChatTurn(role="user", message=input_text),
            ChatTurn(role="assistant", message=output),
        ]
    return [
        ChatTurn(role="user", message=instruction),
        ChatTurn(role="assistant", message=output),
    ]


class Alpaca(ChatTemplateDataset):
    """Stanford Alpaca (Taori et al., 2023).

    Instruction-following dataset with 52k examples generated by
    text-davinci-003.
    """

    def __init__(self, split: str = "train", config: str | None = None) -> None:
        self.ds = load_dataset("tatsu-lab/alpaca", split=split)

    def __len__(self) -> int:
        return len(self.ds)

    def __getitem__(self, idx: int) -> ChatTemplate:
        item = self.ds[idx]
        return template(item["instruction"], item["input"], item["output"])
